<HTML>
    <head>
    </head>

        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
            integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        
        <!-- JQuery -->
        <script src="https://code.jquery.com/jquery-latest.min.js"></script>

        <!-- Bootstrap js -->
        <script src=https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js></script>

        <!-- Chart -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>

        <!-- JQuery -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!-- Bootstrap tooltips -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
        <!-- Bootstrap core JavaScript -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
        <!-- MDB core JavaScript -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"></script>

        <!-- Project Title! -->
        <title>DeepFace</title>    

        <style>

            .img{
                width: 300px;
                height: auto;
            }

            .chart{
                width: 49%;
                height: auto;
                display: inline-block;
                text-align: center;
            }

            .result{
                display: none;
            }

            #loader {
                z-index: 1;
                width: 40px;
                height: 40px;
                /* margin: 30px 0px 0px 50px; */
                border-top:20px;
                border: 6px solid #f3f3f3;
                border-radius: 50%;
                border-top: 6px solid #3498db;
                vertical-align:middle;
                -webkit-animation: spin 3s linear infinite;
                animation: spin 2s linear infinite;
                }

            @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
            }

            @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
            }
            
            @media (max-width: 767px){
                .chart{
                    width: auto;
                    height: auto;
                    display: block;
                }
            }
        </style>
    </head>
    <body>
        <div class = "container">
            <div class="jumbotron mt-3">
                 <!-- Proejct Title -->
                <h1>DeepFace</h1>
                <!-- Github link and Ainize link -->
                <A>Git Hub repository : </A> <A href="https://github.com/woomurf/deepface"> https://github.com/woomurf/deepface </A>
                <br>
                <A>Testing API : </A> <A href=""> on Ainize </A>
                <br>
                <br>
                <h3>Notice</h3>
                <ul>
                    <li> The face may not be detected when: </li>
                    <ol>
                        <li>The quality of the picture is low</li>
                        <li>If the person is not facing the front</li>
                        <li>Similar to the color of the face and the surrounding area</li>
                        <li>etc..</li>
                    </ol>
                    <li>The program can detect only <b>one person</b> per image.</li>
                    <li>Accuracy is not 100%</li>
                    <li>Taked time is depending on model type & image size. About 1s ~ 30s</li>
                </ul>
                <hr class="solid">
                
                <!-- If your project have a input files -->
                <h2>Upload </h2>
                <div id="sampleBox" style="margin-bottom: 5px;">
                    <p style="display:inline">Sample : </p>
                    <a href="../static/sample1.png" target="blank">Sample Image1</a>
                    &nbsp;&nbsp;&nbsp;
                    <a href="../static/sample2.png" target="blank">Sample Image2</a>
                </div>

                <div id="modeWrapper">
                    <p><b>Select mode</b> </p>
                    <input type="radio" name="mode" value="verify" id ="verify" checked="checked" style="margin-right: 5px; margin-bottom: 10px;">
                    <label for="VGG_label">Verify</label>
                    <input type="radio" name="mode" value="analyze" id ="analyze" style="margin-right: 5px; margin-left: 10px; margin-bottom: 10px;">
                    <label for="VGG_label">Analyze</label><br>
                </div>
                <br>

                <!-- Select Method -->
                <div id="methodWrapper">
                    <p><b>Select method</b> </p>
                    <input type="radio" name="method" value="cosine" id ="cosine" checked="checked" style="margin-right: 5px;">
                    <label for="VGG_label">Cosine </label>
                    <input type="radio" name="method" value="euclidean" id ="euclidean" style="margin-left: 10px; margin-right: 5px;">
                    <label for="VGG_label">Euclidean </label>
                    <input type="radio" name="method" value="euclidean_l2" id ="euclidean_l2" style="margin-left: 10px; margin-right: 5px;">
                    <label for="VGG_label">Euclidean_l2 </label>
                </div>
                <br>
                <!-- Select Model -->
                <div id="optionWrapper">
                    <p><b>Select model</b></p>
                    <input type="radio" name="model" value="VGG-Face" checked="checked" style="margin-right: 5px; margin-bottom: 10px;">
                    <label for="VGG_label">VGGFace</label><br>
                    <input type="radio" name="model" value="OpenFace" style="margin-right: 5px; margin-bottom: 10px;">
                    <label for="VGG_label">OpenFace</label><br>
                    <input type="radio" name="model" value="Facenet" style="margin-right: 5px; margin-bottom: 10px;">
                    <label for="VGG_label">Facenet</label><br>
                    <input type="radio" name="model" value="DeepFace" style="margin-right: 5px; margin-bottom: 10px;">
                    <label for="VGG_label">FbDeepFace</label><br>
                    <input type="radio" name="model" value="DeepID" style="margin-right: 5px; margin-bottom: 10px;">
                    <label for="VGG_label">DeepID</label><br>
                </div>
                <br>
                
                <div id ="inputImage">
                    <div>
                        <label for="label1" id="label1">image1 : </label>
                        <input type='file' id='input1' style="margin-right: 10px; margin-bottom: 10px;">
                    </div>
                    <div>
                        <label for="label2" id="label2">image2 : </label>
                        <input type='file' id='input2' style="margin-right: 10px; margin-bottom: 10px;">
                    </div>
                </div>
                <div>
                    <button id="submit" type='submit' class="btn btn-primary btn-lg" style="margin-left: auto;"> RUN </button>
                    <div id = "loader" style="display: none;"></div>
                    <div id="second" style="display: inline-block;"></div>
                </div>
                   
                
                <hr class="solid">

                <div id ="preview_box">
                    <img id="img1" class="img" src="../static/default-image.png">
                    <img id="img2" class="img" src="../static/default-image.png">
                    
                </div>
                
                <!-- Result Box -->
                <div id ='resultBox' style="margin-left: auto; margin-right: auto;">
                    <p id='errorbox'></p>
                    <div id="verifyResult" class="result">
                        <p id="isVerify"></p>
                        <p id="distance"></p>
                        <p id="threshold"></p>
                    </div>
                    <div id="analyzeResult" class="result">
                        <p id="age"></p>
                        <p id="gender"></p>
                        <p id="race"></p>
                        <p id="emotion"></p>
                        <div class="chart" id="raceChartWrapper">
                            <p>Race</p>
                            <canvas id="raceChart"></canvas>
                        </div>
                        <div class="chart" id="emotionChartWrapper">
                            <p>Emotion</p>
                            <canvas id="emotionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- onclick function if you want you can delete this -->
                <script>
                    document.getElementById("submit").onclick = async () => {
                        
                        var second = document.getElementById("second");
                        second.innerHTML = "";
                        waiting();
                        cleanResult();
                        

                        var mode = $("input:radio[name='mode']:checked").val();
                        var data;

                        if(mode == "verify"){
                            data = await get_verify_data();
                        }
                        else{
                            data = await get_analyze_data();
                        }
                        
                        if(data == null){
                            stopWaiting();
                            return null;
                        }
                        var url = "/" + mode;

                        var myHeaders = new Headers();
                        myHeaders.append("Content-Type", "application/json");
                        
                        fetch(
                            url,
                            {
                                method: 'POST',
                                headers: myHeaders,
                                body: JSON.stringify(data),
                                redirect: "follow"
                            }
                        )
                        .then(response => {
                            if (response.status == 200){
                                return response
                            }
                            else if(response.status == 500){
                                document.getElementById("errorbox").innerHTML = "Error: Face could not be detection."
                                throw Error(response)
                            }
                        })
                        .then(response => response.json())
                        .then(response => {
                            stopWaiting();
                            second.innerHTML = "&nbsp;&nbsp; Taked time : " + response["seconds"].toFixed(2) + "s";
                            if(mode == "verify"){
                                viewVerityResult(response["pair_1"]);
                            }
                            else{
                                viewAnalyzeResult(response["instance_1"]);
                            }
                            
                            document.getElementById('errorbox').innerHTML = "";
                        })
                        .catch(e => {
                            // document.getElementById("errorbox").innerHTML = e;
                            stopWaiting();
                            cleanResult();
                        })
                    }

                    function cleanResult(){
                        var verifyResult = document.getElementById("verifyResult");
                        var analyzeResult = document.getElementById("analyzeResult");
                        verifyResult.style.display = "none";
                        analyzeResult.style.display = "none";

                        var raceChart = document.getElementById("raceChart");
                        var emotionChart = document.getElementById("emotionChart");
                        raceChart.remove();
                        emotionChart.remove();

                        $('#raceChartWrapper').append('<canvas id="raceChart"></canvas>')
                        $('#emotionChartWrapper').append('<canvas id="emotionChart"></canvas>')

                    }

                    document.getElementById("verify").onclick = () => {
                        var optionWrapper = document.getElementById("optionWrapper"); 
                        optionWrapper.style.display = "block";
                        var methodWrapper = document.getElementById("methodWrapper");
                        methodWrapper.style.display = "block";
                        var input2 = document.getElementById("input2");
                        input2.style.display = "inline";
                        var label2 = document.getElementById("label2");
                        label2.style.display = "inline-block";
                        var img2 = document.getElementById("img2");
                        img2.style.display = "inline";
                    }

                    document.getElementById("analyze").onclick = () => {
                        var optionWrapper = document.getElementById("optionWrapper");
                        optionWrapper.style.display = "none";
                        var methodWrapper = document.getElementById("methodWrapper");
                        methodWrapper.style.display = "none";
                        var input2 = document.getElementById("input2");
                        input2.style.display = "none";
                        var label2 = document.getElementById("label2");
                        label2.style.display = "none";
                        var img2 = document.getElementById("img2");
                        img2.style.display = "none";
                    }
                    
                    document.getElementById("input1").onchange = (event) =>  {
                        var img1 = document.getElementById('img1');
                        img1.src = URL.createObjectURL(event.target.files[0]);
                        img1.onload = function() {
                            URL.revokeObjectURL(img1.src) // free memory
                        }
                    };

                    document.getElementById("input2").onchange = (event) =>  {
                        var img2 = document.getElementById('img2');
                        img2.src = URL.createObjectURL(event.target.files[0]);
                        img2.onload = function() {
                            URL.revokeObjectURL(img2.src) // free memory
                        }
                    };

                    async function get_verify_data(){
                        var model = $("input:radio[name='model']:checked").val();
                        var method = $("input:radio[name='method']:checked").val();

                        var input1 = document.getElementById("input1").files[0];
                        var input2 = document.getElementById("input2").files[0];
                        
                        if (input1 == undefined || input2 == undefined){
                            document.getElementById("errorbox").innerHTML = "Please input image"
                            return null;
                        }


                        var base64_img1 = await getBase64(input1);
                        var base64_img2 = await getBase64(input2);

                        var data = {
                            "model_name": model, 
                            "distance_metric": method,
                            "img": [
                                {
                                "img1": base64_img1,
                                "img2": base64_img2
                                }   
                            ]
                        }

                        return data;
                    }

                    async function get_analyze_data(){
                        var input1 = document.getElementById("input1").files[0];
                        if (input1 == undefined){
                            document.getElementById("errorbox").innerHTML = "Please input image"
                            return null;
                        }
                        var base64_img = await getBase64(input1);
                    
                        var data = {
                            "img": [
                                base64_img,
                            ]
                        }

                        return data
                    }

                    async function getBase64(file) {
                        var base64URL = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.readAsDataURL(file);
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = error => reject(error);
                        });
                        
                        return base64URL;
                    }

                    function viewVerityResult(response){
                        var analyzeBox = document.getElementById("analyzeResult");
                        var verifyBox = document.getElementById("verifyResult");
                        var isVerify = document.getElementById("isVerify");
                        var distance = document.getElementById("distance");
                        var threshold = document.getElementById("threshold");

                        analyzeBox.style.display = "none";
                        verifyBox.style.display = "block";
                        isVerify.innerHTML = "Result : " + response["verified"];
                        distance.innerHTML = "Distance : " + response["distance"].toFixed(5);
                        threshold.innerHTML = "Threshold : " + response["max_threshold_to_verify"].toFixed(5);
                    }

                    function viewAnalyzeResult(response){

                        var analyzeBox = document.getElementById("analyzeResult");
                        var verifyBox = document.getElementById("verifyResult");
                        var age = document.getElementById("age");
                        var dominant_race = document.getElementById("race");
                        var dominant_emotion = document.getElementById("emotion");
                        var gender = document.getElementById("gender");

                        analyzeBox.style.display = "block";
                        verifyBox.style.display = "none";
                        age.innerHTML = "Age : " + response["age"].toFixed(0);
                        dominant_race.innerHTML = "Race : " + response["dominant_race"];
                        dominant_emotion.innerHTML = "Emotion : " + response["dominant_emotion"];
                        gender.innerHTML = "Gender : " + response["gender"];

                        drawChart(response["race"], "raceChart");
                        drawChart(response["emotion"], "emotionChart");
                    }

                    function drawChart(json_data, name){
                        var labels = [];
                        var data = [];
                        
                        for(var key in json_data){
                            labels.push(key);
                            data.push(json_data[key].toFixed(2));
                        }

                        var colorSet = getColorSet(labels.length);

                        makeChart(name, labels, data, colorSet[0], colorSet[1]);
                    }

                    function getColorSet(num){
                        var colorSet = ["#F94144", "#F3722C", "#F8961E", "#F9C74F", "#90BE6D", "#43AA8B", "#577590"];
                        var hoverColorSet = ["#FA6163", "#F47E3E", "#F9A339", "#F9CC62", "#9FC680", "#50B99A", "#6687A3"];

                        return [colorSet.slice(0,num), hoverColorSet.slice(0,num)];
                    }

                    function makeChart(name, key, values, colorSet, hoverColorSet){

                        var ctxP = document.getElementById(name).getContext('2d');
                        var myPieChart = new Chart(ctxP, {
                        plugins: [ChartDataLabels],
                        type: 'pie',
                        data: {
                            labels: key,
                            datasets: [{
                            data: values,
                            backgroundColor: colorSet,
                            hoverBackgroundColor: hoverColorSet
                            }]
                        },
                        options: {
                            responsive: true,
                            legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                boxWidth: 10
                            }
                            },
                            plugins: {
                            datalabels: {
                                formatter: (value, ctx) => {
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                               
                                let percentage = parseFloat(value).toFixed(2);
                                if (percentage > 5.0){
                                    return percentage + "%";
                                }
                                else{
                                    return null;
                                }
                                },
                                color: 'white',
                                labels: {
                                title: {
                                    font: {
                                    size: '10'
                                    }
                                }
                                }
                            }
                            }
                        }
                        });
                    }

                    function waiting(){
                        var spining = document.getElementById("loader");
                        spining.style.display = 'inline-block';
                        var runButton = document.getElementById("submit");
                        runButton.disabled = "disabled";
                        var errorbox = document.getElementById("errorbox");
                        errorbox.innerHTML = "";
                    }

                    function stopWaiting(){
                        var spining = document.getElementById("loader");
                        spining.style.display = "none";
                        var runButton = document.getElementById("submit");
                        runButton.disabled = false;
                    }
                </script>
            </div>
        </div>
    </body>
</HTML>


